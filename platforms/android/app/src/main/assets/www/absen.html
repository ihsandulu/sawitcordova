<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;"> -->
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src * 'unsafe-inline'; media-src *; img-src * data: content:; script-src * 'unsafe-eval' 'unsafe-inline';">

    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">
    <meta name="color-scheme" content="light dark">

    <!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> -->

    <link rel="stylesheet" href="css/all.min.css"/>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/select2.min.css"/>
    <link rel="stylesheet" href="css/umum.css">


    <title>PT. PAM</title>
    <style>   
        #datanfcjadi{
            height: 300px !important; 
            width: 300px; 
            position: relative;
            left: 50%;
            top:0px;
            transform: translate(-50%,0);
        } 
        #absen{
            margin-bottom: 500px!important;
        }
    </style>
    <script>
    </script>
</head>

<body>    
    <div id="header">
        
    </div>
    <div id="frame1" class="text-center mb-5" > 
        <div id="htmlupload">
            <!-- Isi div -->
        </div>
        <div class="row p-3 ballon">                   
            <H1 class="col-12 alert alert-success"><button id="btnupload" onclick="confirmupload();" class="btn btn-danger btn-xs text-white"><i class="fas fa-upload"></i></button> Absensi</H1>        
                 
            <div class="col-5 mb-4 text-left">Jenis</div><div class="col-7 text-left">
                <select onchange="tp()" id="absen_type" class="">
                    <option value="">Pilih Jenis Absensi</option>
                    <option value="Masuk">Masuk</option>
                    <option value="Keluar">Keluar</option>
                    <option value="Izin">Izin</option>
                    <option value="Sakit">Sakit</option>
                    <option value="Mangkir">Mangkir</option>
                </select>
            </div>             
            <div class="col-5 mb-4 text-left">Keterangan</div>
            <div class="col-7 text-left">
                <input id="absen_note" type="text" class="form-control">
            </div>             
            <div class="col-5 mb-4 text-left">Geolocation</div>
            <div class="col-7 text-left">
                <input id="absen_geo" type="text" readonly class="form-control" placeholder="" aria-label="Geolocation" aria-describedby="btn_geo">
            </div>   
            <div class="col-5 mb-4 text-left">Estate</div><div class="col-7 text-left">
                <input readonly type="text" id="estate_name" class="form-control">
            </div>      
            <div class="col-5 mb-4 text-left">Divisi</div><div class="col-7 text-left">
                <input readonly type="text" id="divisi_name" class="form-control">
            </div>                         
            <div class="col-5 mb-4 text-left">Tenaga absen</div><div class="col-7 text-left">
                <select onchange="tp()" id="absen_user" class="form-control select2">

                </select>
            </div>     
            <div class="col-12 text-left input-group absenpctr">Picture</div>
            <div class="input-group mb-4 absenpctr">
                <input readonly id="absen_picture" type="text" class="form-control text-biru" placeholder="" aria-label="Picture" aria-describedby="btn_picture">
                <button onclick="pictureAbsen()" class="btn btn-outline-secondary" type="button" id="btn_picture"><i class="fas fa-camera"></i></button>
                <img id="absenPicture" src="res/no_picture.png" class="img-thumbnail">
            </div> 
            <textarea id="codeerror" class="hide"></textarea>

            <button  type="button" id="submit" onclick="submit()" type="button" class="btn btn-primary hide">Submit</button>
            <input id="estate_id" type="hidden">
            <input id="divisi_id" type="hidden">
            <input id="absen_date" type="hidden">
            <input id="absen_time" type="hidden">
            <input id="absen_username" type="hidden">
        </div>
        <div class="mb-5" id="absen">  
        
        </div>
    </div>


    <div id="footer"></div>
    <script type="text/javascript" src="cordova.js"></script>  
    <script type="text/javascript" src="js/jquery.min.js"></script>    
    <script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="js/select2.min.js"></script>
    <script type="text/javascript" src="js/umum.js"></script>
    <script type="text/javascript" src="js/data.js"></script>
    <script type="text/javascript" src="js/nfc.js"></script>
    <script>
        //device ready 
        document.addEventListener('deviceready', function () { 
            $(".absenpctr").hide();
            
            if(username==null){
                window.location.href='login.html';
            }else{
                $(".username").text(username); 
                geoAbsen();
                setInterval(function(){
                    geoAbsen();
                },10000);  
                getAbsenceType();            
                tpname();
                $("#estate_id").val(estateid);
                $("#divisi_id").val(divisiid);
                $("#estate_name").val(estatename);
                $("#divisi_name").val(divisiname);
                $("#absen_date").val(now());
                $("#absen_time").val(time());
                ambildata('absen','semua','');
                deviceStart();
                TesseractPlugin.loadLanguage('eng', function(response) {
                    deferred.resolve(response);
                }, function(reason) {
                    deferred.reject('Error on loading OCR file for your language. ' + reason);
                });
            }                      
        }); 

        function cekdatasemua(){
            db.transaction(function (tx) {
                var query = `SELECT * FROM absen WHERE 1`;  
                tx.executeSql(query, [], function (tx, resultSet) { 
                    // notif(resultSet.rows.length);
                    if (resultSet.rows.length>0) { 
                        $("#btnupload").show();
                    } else{
                        $("#btnupload").hide();
                    }
                });
            });
        }

        function bacafile(fileName) {
            let fname = fileName+".txt";
            // alert(fileName);
            window.resolveLocalFileSystemURL(cordova.file.externalDataDirectory, function(directoryEntry) {
                directoryEntry.getFile(fname, { create: false }, function(fileEntry) {
                    fileEntry.file(function (file) {
                        var reader = new FileReader();

                        reader.onloadend = function () {
                            $("#p"+fileName).val(this.result); 
                            setTimeout(function(){                                
                                $("#psubmit"+fileName).click();
                            },3000);
                        };

                        reader.readAsText(file);
                    }, onErrorReadFile);
                }, onErrorReadFile);
            }, onErrorReadFile);
        }

        function onErrorReadFile1(error, x, no, resultSet){
            notif('x='+x+", no="+no+"=>1"+JSON.stringify(error).toString());
            finalupload("",x,no,resultSet);
        }

        
        function onErrorReadFile2(error, x, no, resultSet){
            // notif('x='+x+", no="+no+"=>2"+JSON.stringify(error).toString());
            finalupload("",x,no,resultSet);
        }

        
        function onErrorReadFile3(error, x, no, resultSet){
            notif('x='+x+", no="+no+"=>3"+JSON.stringify(error).toString());
            finalupload("",x,no,resultSet);
        }

        function bacafileajax(fileName, x, no, resultSet, callback) {
            let fname = fileName+".txt";
            // alert(fileName);
            window.resolveLocalFileSystemURL(cordova.file.externalDataDirectory, function(directoryEntry) {
                directoryEntry.getFile(fname, { create: false }, function(fileEntry) {
                    fileEntry.file(function (file) {
                        var reader = new FileReader();

                        reader.onloadend = function () {
                            // alert(this.result);
                            callback(this.result, x, no, resultSet);
                        };

                        reader.readAsText(file);
                    }, function(error) {
                        onErrorReadFile1(error, x, no, resultSet); 
                    });
                }, function(error) {
                    onErrorReadFile2(error, x, no, resultSet);
                });
            }, function(error) {
                onErrorReadFile3(error, x, no, resultSet); 
            });
        }

        function deletefile(nama_file){
            var fileName = nama_file+".txt";

            window.resolveLocalFileSystemURL(cordova.file.externalDataDirectory, function(directoryEntry) {
                directoryEntry.getFile(fileName, {create: false}, function(fileEntry) {
                    fileEntry.remove(function() {
                        // File berhasil dihapus
                        console.log("File berhasil dihapus: " + fileName);
                    }, function(error) {
                        // Gagal menghapus file
                        console.error("Gagal menghapus file: " + error.code);
                    });
                }, function(error) {
                    // File tidak ditemukan
                    console.error("File tidak ditemukan: " + error.code);
                });
            }, function(error) {
                // Direktori tidak ditemukan
                console.error("Direktori tidak ditemukan: " + error.code);
            });

        }

        function confirmupload1(pilihannya) {
            if(pilihannya=='1'){
                uploaddata();
            }else{
                // alert('You selected button ' + jenis);
            }
        }

        function confirmupload(){
            let arraynya = ['Upload','Cancel'];
            navigator.notification.confirm(
                "Yakin di Upload?", // message
                (buttonIndex) => confirmupload1(buttonIndex),            
                "Upload",           // title
                arraynya     // buttonLabels
            );
        }

        function finalupload(result,x,no,resultSet){
            $("#loader").show();
            var absen_id = resultSet.rows.item(x)['absen_id'];
            var absen_user = resultSet.rows.item(x)['absen_user'];
            var absen_username = resultSet.rows.item(x)['absen_username'];
            var absen_date = resultSet.rows.item(x)['absen_date'];
            var absen_time = resultSet.rows.item(x)['absen_time'];
            var absen_type = resultSet.rows.item(x)['absen_type'];
            var absen_note = resultSet.rows.item(x)['absen_note'];
            var estate_id = resultSet.rows.item(x)['estate_id'];
            var estate_name = resultSet.rows.item(x)['estate_name'];
            var divisi_id = resultSet.rows.item(x)['divisi_id'];
            var divisi_name = resultSet.rows.item(x)['divisi_name'];
            var absen_geo = resultSet.rows.item(x)['absen_geo'];
            var absen_picture = resultSet.rows.item(x)['absen_picture'];

            // Membuat objek FormData
            var formData = new FormData();
            formData.append('absen_user', absen_user);
            formData.append('absen_username', absen_username);
            formData.append('absen_date', absen_date);
            formData.append('absen_time', absen_time);
            formData.append('absen_type', absen_type);
            formData.append('absen_note', absen_note);
            formData.append('estate_id', estate_id);
            formData.append('estate_name', estate_name);
            formData.append('divisi_id', divisi_id);
            formData.append('divisi_name', divisi_name);
            formData.append('absen_geo', absen_geo);
            isipicture = result;
            formData.append('absen_picture', isipicture);

            // alert(isipicture);
            // Melakukan AJAX request
            $.ajax({
                url: 'https://parnaagromas.com/tphdigital/api/absen',
                type: 'POST',
                data: formData,
                processData: false,  // Tetapkan ke false agar FormData tidak diproses secara otomatis
                contentType: false,  // Tetapkan ke false karena FormData sudah berisi tipe konten yang benar
                success: function(response) {
                    
                    db.transaction(function (tx) {
                        var query1 = "DELETE FROM absen WHERE absen_id = "+absen_id;
                        let text1='';
                        tx.executeSql(query1, [], function (tx, resultSet1) { 
                            /* for (let [key, value] of formData.entries()) {
                                text1+=`${key}: ${value}`;
                            }
                            notif(text1); */

                            deletefile(absen_user);
                            ambildata('absen','semua','');
                            if(no==resultSet.rows.length){
                                notif('Sukses Upload Data!');
                                clearField();                   
                                playAudio('berhasil.mp3');                                
                                $("#loader").hide();
                            }                                           
                        },
                        function (tx, error) {
                            notif('DELETE error: ' + error.message);                      
                            playAudio('gagal.mp3');
                        });
                        
                        // alert(no+"=="+resultSet.rows.length);
                    });

                    
                    
                },
                error: function(xhr, status, error) {
                    notif('Error:', error);
                }
            });
        }

        function uploaddata(){
            db.transaction(function (tx) {
                let hariini = now();
                // var query = `SELECT * FROM absen WHERE absen_date = '${hariini}'`; 
                var query = `SELECT * FROM absen WHERE 1`;                
                // notif(query);
                $("#htmlupload").html('');
                tx.executeSql(query, [], function (tx, resultSet) { 
                    let no=1;
                    // notif(resultSet.rows.length);
                    for (var x = 0; x < resultSet.rows.length; x++) {                        
                        /* var cell ='<form action="https://parnaagromas.com/tphdigital/api/absen" class="form-horizontal" method="post" enctype="multipart/form-data">';
                        cell += '<input name="absen_user" value="'+resultSet.rows.item(x)['absen_user']+'">'; 
                        cell += '<input name="absen_username" value="'+resultSet.rows.item(x)['absen_username']+'">'; 
                        cell += '<input name="absen_date" value="'+resultSet.rows.item(x)['absen_date']+'">'; 
                        cell += '<input name="absen_time" value="'+resultSet.rows.item(x)['absen_time']+'">'; 
                        cell += '<input name="absen_type" value="'+resultSet.rows.item(x)['absen_type']+'">'; 
                        cell += '<input name="estate_id" value="'+resultSet.rows.item(x)['estate_id']+'">'; 
                        cell += '<input name="estate_name" value="'+resultSet.rows.item(x)['estate_name']+'">'; 
                        cell += '<input name="divisi_id" value="'+resultSet.rows.item(x)['divisi_id']+'">'; 
                        cell += '<input name="divisi_name" value="'+resultSet.rows.item(x)['divisi_name']+'">'; 
                        cell += '<input name="absen_geo" value="'+resultSet.rows.item(x)['absen_geo']+'">'; 
                        cell += '<input id="p'+resultSet.rows.item(x)['absen_user']+'" name="absen_picture" value="'+resultSet.rows.item(x)['absen_picture']+'">'; 
                        cell += '<button  type="submit" id="psubmit'+resultSet.rows.item(x)['absen_user']+'" type="submit" class="btn btn-primary">Submit</button>';
                        cell += '</form>';                         
                        $("#htmlupload").append(cell);                        
                        bacafile(resultSet.rows.item(x)['absen_user']); */

                        
                        let isipicture;                        
                        var absen_picture = resultSet.rows.item(x)['absen_picture'];
                        bacafileajax(absen_picture,x,no,resultSet, function(result,x,no,resultSet) {
                            finalupload(result,x,no,resultSet);
                        });
                        
                            no++;
                        
                        
                    }
                });
            });
        }


        function upload(formname) {
            $("#"+formname).on('submit',(function(e) {
                let a = new FormData(this);
                e.preventDefault();
                $.ajax({
                    url: "https://parnaagromas.com/tphdigital/api/absen",
                    type: "POST",
                    data:  new FormData(this),
                    contentType: false,
                    cache: false,
                    processData:false,
                    beforeSend : function()
                    {
                        //$("#preview").fadeOut();
                        $("#err").fadeOut();
                    },
                    success: function(data)
                    {
                        if(data=='invalid')
                        {
                            // invalid file format.
                            $("#err").html("Invalid File !").fadeIn();
                        }
                        else
                        {
                            // view uploaded file.
                            $("#preview").html(data).fadeIn();
                            $("#form")[0].reset(); 
                        }
                    },
                    error: function(e) 
                    {
                        $("#err").html(e).fadeIn();
                    }          
                });
            }));
        }


        function getAbsenceType() {
            const currentTime = new Date();
            const currentHour = currentTime.getHours();
            if (currentHour >= 0 && currentHour < 12) {
                $("#absen_type").val("Masuk");
            } else {
                $("#absen_type").val("Keluar");
            }
        }


        //gambar 
        function writeToFile(fileName, text) {
            let fname = fileName+".txt";
            // alert(fname);
            window.resolveLocalFileSystemURL(cordova.file.externalDataDirectory, function(directoryEntry) {
                directoryEntry.getFile(fname, { create: true }, function(fileEntry) {
                    fileEntry.createWriter(function(fileWriter) {
                        fileWriter.onwriteend = function() {
                            $("#absenPicture").attr("src", text); 
                        };

                        fileWriter.onerror = function(e) {
                            notif("Gagal menulis ke file: " + e.toString());
                        };

                        var blob = new Blob([text], { type: 'text/plain' });
                        fileWriter.write(blob);
                    }, function(error) {
                        notif("Gagal membuat writer: " + error.toString());
                    });
                }, function(error) {
                    notif("Gagal mendapatkan file: " + error.toString());
                });
            }, function(error) {
                notif("Gagal mengakses direktori: " + error.toString());
            });
        }

        function readFromFile(fileName) {
            let fname = fileName+".txt";
            // alert(fileName);
            window.resolveLocalFileSystemURL(cordova.file.externalDataDirectory, function(directoryEntry) {
                directoryEntry.getFile(fname, { create: false }, function(fileEntry) {
                    fileEntry.file(function (file) {
                        var reader = new FileReader();

                        reader.onloadend = function () {
                            // alert(fileName+"=="+this.result);
                            $("#"+fileName).attr("src", this.result); 
                        };

                        reader.readAsText(file);
                    }, onErrorReadFile);
                }, onErrorReadFile);
            }, onErrorReadFile);
        }

        function onErrorReadFile(error){
            // notif(JSON.stringify(error).toString());
        }
      

        function absenImg(imageURI) {
            let src =  imageURI;  
            src =  "data:image/jpeg;base64," + imageURI;          
            // $("#absenPicture").attr("src", src); 
            let absen_picture = $("#absen_picture").val();
            // alert(absen_picture);
            writeToFile(absen_picture, src);  
            $("#submit").show();          
        }
        function errorabsenImg(message) {
            notif('Failed because: ' + message);
        }
        function pictureAbsen() {
            navigator.camera.getPicture(absenImg, errorabsenImg, {quality: 50, destinationType: Camera.DestinationType.DATA_URL, correctOrientation: true});
            // navigator.camera.getPicture(absenImg, errorabsenImg, {quality: 50, destinationType: Camera.DestinationType.FILE_URI, correctOrientation: true});
        }

        //geolocation
        var absenGeo = function (position) {
                let geolo = position.coords.latitude+'|'+position.coords.longitude;
                $("#absen_geo").val(geolo);
        };
        function errorGeo(error) {
            notif('code: ' + error.code + '\n' +
                'message: ' + error.message + '\n');
        }
        function geoAbsen() {
            navigator.geolocation.getCurrentPosition(absenGeo, errorGeo);
        }
        
        function clearField(){
            $("#absen_user").val("");
            $("#absen_type").val("");
            $("#absen_note").val("");
            tpname();
            tp();
            $("#absen_date").val("");
            $("#absen_time").val("");
            
            $("#absen_date").val(now());
            $("#absen_time").val(time());

            $("#absen_picture").val("");
            $("#absenPicture").attr("src","res/no_picture.png");  
            
            getAbsenceType();  
             
            $("#submit").hide();                   
        }
        
        function submit(){
            let absen_user = $("#absen_user").val();
            let absen_username = $("#absen_username").val();
            let absen_type = $("#absen_type").val();
            let absen_note = $("#absen_note").val();
            let estate_id = $("#estate_id").val();
            let estate_name = $("#estate_name").val();
            let divisi_id = $("#divisi_id").val();
            let divisi_name = $("#divisi_name").val();
            let absen_geo = $("#absen_geo").val();

            
            let absen_date = now();
            let absen_time = $("#absen_time").val();

            let absen_picture = $("#absen_picture").val();
            
            let data = 'absen_user='+absen_user+
                ',absen_username='+absen_username+
                ',absen_type='+absen_type+
                ',absen_note='+absen_note+
                ',absen_date='+absen_date+
                ',absen_time='+absen_time+
                ',estate_id='+estate_id+
                ',estate_name='+estate_name+
                ',divisi_id='+divisi_id+
                ',divisi_name='+divisi_name+
                ',absen_geo='+absen_geo+
                ',absen_picture='+absen_picture;
                // notif(data);
            inputOrUpdateData('absen', data);

        }

        function updatedataabsen(table,columns,valuesUpdate,absen_id){
            db.transaction(function (tx) {
                var updateQuery = "UPDATE " + table + " SET " + columns.join('=?, ') + "=? WHERE absen_id = '"+ absen_id + "'";
                            // notif(updateQuery);
                tx.executeSql(updateQuery, valuesUpdate, function (tx, res) {
                    ambildata('absen','semua','');  
                    playAudio('berhasil.mp3');
                }, function (tx, error) {
                    notif('Kesalahan UPDATE: ' + error.message);            
                    playAudio('gagal.mp3');
                });
            });
        }
        
        function onConfirmUpdate(pilihannya,table,columns,valuesUpdate,absen_id) {
            if(pilihannya=='1'){
                updatedataabsen(table,columns,valuesUpdate,absen_id);
            }else{
                // alert('You selected button ' + jenis);
            }
        }

        function confirmUpdateabsen(message,title,table,columns,valuesUpdate,absen_id) {
            let arraynya = ['Update','Cancel'];
            navigator.notification.confirm(
                message, // message
                (buttonIndex) => onConfirmUpdate(buttonIndex, table,columns,valuesUpdate,absen_id),            
                title,           // title
                arraynya     // buttonLabels
            );
        }

        

        function inputOrUpdateData(table, data) {
            // notiftext(data);
            db.transaction(function (tx) {
                var dataArray = data.split(',');
                var columns = [];
                var values = [];
                var valuesUpdate = [];

                var absenidCheck = '';
                var absenidCheckUpdate = '';
                var absenmandor = '';
                dataArray.forEach(function (item) {
                    var pair = item.split('=');
                    columns.push(pair[0]);
                    if(pair[0]=="absen_picture" || pair[0]=="absen_geo"){
                        let isi = (pair[1] === 'null') ? "NULL" : "'" + pair[1] + "'";
                        let isiUpdate = (pair[1] === 'null') ? "NULL" : pair[1];
                        values.push(isi);                 
                        valuesUpdate.push(isiUpdate); 
                    }else{
                        let isi = (pair[1] === 'null') ? "NULL" : "'" + pair[1].trim() + "'";
                        let isiUpdate = (pair[1] === 'null') ? "NULL" : pair[1].trim();
                        values.push(isi);                 
                        valuesUpdate.push(isiUpdate); 
                    }
                                         
                });

                // Mengecek apakah absen_baris sudah ada dalam tabel
                let useridn = $("#absen_user").val();
                let hariini = now();
                let tipe = $("#absen_type").val();
                if(absen_type=="Masuk"){
                    var checkQuery = `SELECT * FROM absen WHERE absen_date = ? AND absen_type = '${tipe}' AND absen_user=?`;
                }else{
                    var checkQuery = `SELECT * FROM absen WHERE absen_date = ?  AND absen_type = '${tipe}' AND absen_user=?`;
                }
                tx.executeSql(checkQuery, [hariini, useridn], function (tx, result) {
                    let jmldata = result.rows.length;
                    // notif(jmldata); 
                    if (jmldata > 0) {
                        let absen_id = result.rows.item(0)['absen_id'];
                        confirmUpdateabsen('Data sudah ada. Apakah akan ditimpa?','Data Ditemukan',table,columns,valuesUpdate,absen_id)
                        // Jika absen_baris sudah ada, lakukan UPDATE
                        clearField();
                    } else {
                        // Jika absen_baris belum ada, lakukan INSERT
                        var insertQuery = "INSERT INTO " + table + " (" + columns.join(',') + ") VALUES (" + values.join(',') + ")";
                        // notif(insertQuery);
                        tx.executeSql(insertQuery, [], function (tx, res) {
                            insertID = res.insertId;
                            // notif(insertID);
                            ambildata('absen','semua','');  
                            playAudio('berhasil.mp3'); 
                            clearField();
                        }, function (tx, error) {
                            notif('Kesalahan INSERT: ' + error.message);      
                            playAudio('gagal.mp3');
                        });
                    }
                    clearField();
                }, function (tx, error) {
                    $("#codeerror").val(error.message); 
                    notif('Kesalahan transaksi: ' + error.message);      
                    playAudio('gagal.mp3');
                });
            }, function (error) {
                notif('Transaction Error: ' + error.message);      
                playAudio('gagal.mp3');
            }, function () {
                // playAudio('berhasil.mp3');
                // notif('Data Telah Terhapus!');
            });
        }        

        function deleteabsen(table,id){
            db.transaction(function (tx) {
                var query = "DELETE FROM " + table + " WHERE " + table + "_id = ?";
                tx.executeSql(query, [id], function (tx, res) {
                    ambildata(table,'semua','');
                    notif('Data Telah Terhapus!'); 
                    playAudio('dataterhapus.mp3');  
                },
                function (tx, error) {
                    notif('DELETE error: ' + error.message);                      
                    playAudio('gagal.mp3');
                });
            }, function (error) {
                notif('transaction error: ' + error.message);      
                playAudio('gagal.mp3');
            }, function () { 
            });
        }

        function onConfirmDelete(pilihannya,table,id) {
            if(pilihannya=='1'){
                deleteabsen(table,id);
            }else{
                // alert('You selected button ' + jenis);
            }
        }

        function confirmdeleteabsen(message,title,table,id) {
            let arraynya = ['Delete','Cancel'];
            navigator.notification.confirm(
                message, // message
                (buttonIndex) => onConfirmDelete(buttonIndex, table, id),            
                title,           // title
                arraynya     // buttonLabels
            );
        }

        function tpname(){            
            db.transaction(function (tx) {
                var query = "SELECT * FROM tp WHERE divisi_id='"+divisiid+"' ORDER BY panen_tpname ASC";
                // notif(query);
                $("#absen_user").html('');
                var cell ='';
                tx.executeSql(query, [], function (tx, resultSet) {
                    let no=1;
                    // notif(resultSet.rows.length);     
                    cell += '<option value="">Pilih Tenaga absen</option>';
                    for (var x = 0; x < resultSet.rows.length; x++) {   
                        cell += '<option panen_tpname="'+resultSet.rows.item(x)['panen_tpname']+'" value="'+resultSet.rows.item(x)['panen_tp']+'">'+resultSet.rows.item(x)['panen_placement']+' - '+resultSet.rows.item(x)['panen_tpname']+' ('+resultSet.rows.item(x)['panen_tpnik']+')</div>';
                        if(resultSet.rows.length == no){
                            $("#absen_user").append(cell);
                        }
                        no++;
                        
                    }
                    if (x < 1) {
                        // notif("Tidak ada data!");
                    }
                },
                function (tx, error) {
                    notif('SELECT error: ' + error.message);   
                    playAudio('gagal.mp3');
                });
                
            }, function (error) {
                notif('transaction error: ' + error.message);   
                playAudio('gagal.mp3');
            }, function () {
                // notif('transaction ok');
            });
        }
        
        function tp(){            
            let absen_username = $("#absen_user").find(':selected').attr('panen_tpname');
            $("#absen_username").val(absen_username);
            let absenuser = $("#absen_user").val();
            let absentype = $("#absen_type").val();
            let absendate = $("#absen_date").val();
            let absen_picture = absenuser+absentype+absendate;
            if(absenuser>0){                
                $("#submit").show();          
                $(".absenpctr").show();
                $("#absen_picture").val(absen_picture);
            }else{
                $(".absenpctr").hide();
                $("#absen_picture").val("");
            }
        }
        
        
        function ambildata(table,status,perintahkartu) {
            cekdatasemua();
            db.transaction(function (tx) {
                let hariini = now();
                let tipe = $("#absen_type").val();
                /* if(absen_type=="Masuk"){
                    var query = `SELECT * FROM absen WHERE absen_date = '${hariini}' AND absen_type = '${tipe}'`;
                }else{
                    var query = `SELECT * FROM absen WHERE absen_date = '${hariini}' AND absen_type = '${tipe}'`;
                } */
                
                var query = `SELECT * FROM absen WHERE absen_date = '${hariini}'`;
                
                // notif(query);
                $("#"+table).html('');
                
                  
                tx.executeSql(query, [], function (tx, resultSet) { 
                    let no=1;
                    // notif(resultSet.rows.length);
                    let tdataabsenharian='';   
                    for (var x = 0; x < resultSet.rows.length; x++) {  
                        if(x==0){
                            let ab = '<div class="col-12 text-center alert alert-success mb-3">.: Data Berhasil Absen :.</div>';
                            $("#"+table).append(ab);
                        }                      
                        var cell ='';
                        cell += '<div class="row p-3 ballon">'; 

                        let dataabsenharian = '*'+
                            'absen_user='+resultSet.rows.item(x)['absen_user']+
                            ',absen_username='+resultSet.rows.item(x)['absen_username']+
                            ',absen_date='+resultSet.rows.item(x)['absen_date']+
                            ',absen_time='+resultSet.rows.item(x)['absen_time']+
                            ',absen_type='+resultSet.rows.item(x)['absen_type']+
                            ',absen_note='+resultSet.rows.item(x)['absen_note']+
                            ',estate_id='+resultSet.rows.item(x)['estate_id']+
                            ',estate_name='+resultSet.rows.item(x)['estate_name']+
                            ',divisi_id='+resultSet.rows.item(x)['divisi_id']+
                            ',divisi_name='+resultSet.rows.item(x)['divisi_name']+
                            ',absen_geo='+resultSet.rows.item(x)['absen_geo']+
                            ',absen_picture='+resultSet.rows.item(x)['absen_picture'];

                        tdataabsenharian +=dataabsenharian;

                        cell += '<div class="col-12 text-center alert alert-success mb-3">('+resultSet.rows.item(x)['absen_id']+') '+resultSet.rows.item(x)['absen_username']+'</div>';
                        cell += '<div class="col-4 text-left">Jenis</div><div class="col-8 text-left">: &nbsp;&nbsp;'+resultSet.rows.item(x)['absen_type']+'</div>';
                        cell += '<div class="col-4 text-left">Keterangan</div><div class="col-8 text-left">: &nbsp;&nbsp;'+resultSet.rows.item(x)['absen_note']+'</div>';
                        cell += '<div class="col-4 text-left">Date</div><div class="col-8 text-left">: &nbsp;&nbsp;'+sekarang()+' '+resultSet.rows.item(x)['absen_time']+'</div>';
                        cell += '<div class="col-4 text-left">Estate</div><div class="col-8 text-left">: &nbsp;&nbsp;'+resultSet.rows.item(x)['estate_name']+'</div>';
                        cell += '<div class="col-4 text-left">Divisi</div><div class="col-8 text-left">: &nbsp;&nbsp;'+resultSet.rows.item(x)['divisi_name']+'</div>';
                        cell += '<div class="col-4 text-left">Geolocation</div><div class="col-8 text-left">: &nbsp;&nbsp;'+resultSet.rows.item(x)['absen_geo']+'</div>';

                        let srcpic='res/no_picture.png';
                        let absenuser = resultSet.rows.item(x)['absen_user'];
                        let absentype = resultSet.rows.item(x)['absen_type'];
                        let absendate = resultSet.rows.item(x)['absen_date'];
                        let absen_picture = absenuser+absentype+absendate;
                        cell += '<div class="col-4 text-left">Picture</div><div class="col-8 text-left">: &nbsp;&nbsp;<img id="'+absen_picture+'" src="'+srcpic+'" class="img-thumbnail"></div>';
                        if(resultSet.rows.item(x)['absen_picture']!=""){
                            // alert(resultSet.rows.item(x)['absen_picture']+"=="+absen_picture);
                            readFromFile(resultSet.rows.item(x)['absen_picture']);
                            // $("#"+resultSet.rows.item(x)['absen_user']).attr("src","res/logo.png");
                        }

                        cell += '<div onclick="confirmdeleteabsen(\'Yakin di Delete?\',\'Delete Data\',\'absen\',\''+resultSet.rows.item(x)['absen_id']+'\')" class="col-12  mt-5 mb-5 text-danger"> >>> &nbsp;&nbsp;<button class="btn btn-danger btn-block"><i class="fas fa-window-close"></i> Delete</button>&nbsp;&nbsp; <<< </div>';  
                                  
                        cell +='</div>';
                        $("#"+table).append(cell);      
                        
                     
                        no++;
                    }
                    if (x < 1) {
                        // notif("Tidak Ada Data di Database!");      
                        // playAudio('datakosong.mp3');
                    }
                },
                function (tx, error) {
                    notif('SELECT error: ' + error.message);    
                    playAudio('gagal.mp3');
                });
                
            
            });
        }

        
    </script>
</body>

</html>